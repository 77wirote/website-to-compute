<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>กล้องถ่ายภาพ (หน้าจอสีดำ)</title>
    <!-- โหลด Tailwind CSS เพื่อการจัดสไตล์ที่ง่ายและตอบสนอง -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* กำหนดฟอนต์หลักและซ่อนแถบเลื่อน */
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* ป้องกันการเลื่อนหน้าจอ */
        }
        /* สไตล์สำหรับวิดีโอฟีดจากกล้อง */
        #camera-feed {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; /* ทำให้วิดีโอครอบคลุมพื้นที่ทั้งหมด */
            transform: scaleX(-1); /* สะท้อนภาพกล้องหน้าเพื่อให้เหมือนเซลฟี่ */
            z-index: 1; /* อยู่ด้านล่างของโอเวอร์เลย์ */
        }
        /* สไตล์สำหรับโอเวอร์เลย์สีดำที่ครอบคลุมทั้งหน้าจอ */
        #black-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            z-index: 2; /* อยู่เหนือวิดีโอฟีด */
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5rem;
            cursor: pointer; /* แสดงเคอร์เซอร์เป็นรูปมือเมื่อชี้ */
        }
        /* Canvas ที่ใช้สำหรับจับภาพ (ซ่อนไว้) */
        #capture-canvas {
            display: none; /* ซ่อน canvas ไม่ให้แสดงบนหน้าจอ */
        }
        /* กล่องข้อความสำหรับแสดงข้อความแจ้งเตือน (แทน alert()) */
        #message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8); /* พื้นหลังทึบแสง */
            color: white;
            padding: 20px;
            border-radius: 8px;
            z-index: 100; /* อยู่เหนือองค์ประกอบอื่นๆ ทั้งหมด */
            display: none; /* ซ่อนไว้ในตอนแรก */
            text-align: center;
        }
        /* ปุ่มตกลงในกล่องข้อความ */
        #message-box button {
            background-color: #3B82F6; /* สีน้ำเงิน (Tailwind blue-500) */
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            margin-top: 10px;
            cursor: pointer;
            border: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">

    <!-- วิดีโอฟีดจากกล้อง (ซ่อนอยู่หลังโอเวอร์เลย์สีดำ) -->
    <video id="camera-feed" autoplay playsinline></video>

    <!-- โอเวอร์เลย์สีดำที่ครอบคลุมทั้งหน้าจอและเป็นพื้นที่สำหรับแตะเพื่อถ่ายภาพ -->
    <div id="black-overlay" class="rounded-lg">
        <!-- ไม่มีข้อความหรือรูปภาพใดๆ แสดงที่นี่ หน้าจอจะเป็นสีดำสนิท -->
    </div>

    <!-- Canvas ที่ซ่อนไว้สำหรับใช้จับภาพจากวิดีโอฟีด -->
    <canvas id="capture-canvas"></canvas>

    <!-- กล่องข้อความสำหรับแสดงการแจ้งเตือนต่างๆ -->
    <div id="message-box" class="rounded-lg shadow-lg">
        <p id="message-text"></p>
        <button id="message-ok-button">ตกลง</button>
    </div>

    <script>
        // รับการอ้างอิงถึงองค์ประกอบ DOM
        const video = document.getElementById('camera-feed');
        const canvas = document.getElementById('capture-canvas');
        const blackOverlay = document.getElementById('black-overlay');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const messageOkButton = document.getElementById('message-ok-button');
        let stream; // ตัวแปรสำหรับเก็บสตรีมจากกล้อง

        /**
         * แสดงกล่องข้อความที่กำหนดเองแทน alert().
         * @param {string} message ข้อความที่จะแสดง.
         */
        function showMessageBox(message) {
            messageText.textContent = message;
            messageBox.style.display = 'block';
        }

        // เพิ่ม Event Listener สำหรับปุ่ม "ตกลง" ในกล่องข้อความ
        messageOkButton.addEventListener('click', () => {
            messageBox.style.display = 'none';
        });

        /**
         * เริ่มต้นการทำงานของกล้อง.
         */
        async function initCamera() {
            try {
                // ขออนุญาตเข้าถึงกล้องของผู้ใช้
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream; // กำหนดแหล่งที่มาของวิดีโอเป็นสตรีมจากกล้อง

                // เล่นวิดีโอเมื่อข้อมูลเมตาโหลดเสร็จสิ้น
                video.onloadedmetadata = () => {
                    video.play();
                    // ปรับขนาด canvas ให้ตรงกับขนาดของวิดีโอฟีด
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                };
            } catch (err) {
                console.error('Error accessing camera:', err);
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    showMessageBox('ไม่สามารถเข้าถึงกล้องได้: โปรดอนุญาตการเข้าถึงกล้องในเบราว์เซอร์ของคุณ');
                } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                    showMessageBox('ไม่พบอุปกรณ์กล้อง: ตรวจสอบว่ากล้องของคุณเชื่อมต่ออยู่และใช้งานได้');
                } else {
                    showMessageBox(`เกิดข้อผิดพลาดในการเข้าถึงกล้อง: ${err.message}`);
                }
            }
        }

        /**
         * จับภาพจากวิดีโอฟีดและเปิดในแท็บใหม่.
         */
        function captureImage() {
            if (!stream || video.videoWidth === 0 || video.videoHeight === 0) {
                showMessageBox('กล้องยังไม่พร้อมหรือไม่มีข้อมูลวิดีโอ');
                return;
            }

            const context = canvas.getContext('2d');
            // วาดเฟรมปัจจุบันของวิดีโอลงบน canvas
            // สะท้อนภาพแนวนอนเพื่อให้ภาพที่จับได้เหมือนเซลฟี่
            context.translate(canvas.width, 0);
            context.scale(-1, 1);
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            context.setTransform(1, 0, 0, 1, 0, 0); // รีเซ็ตการแปลง

            // รับข้อมูลรูปภาพเป็น Data URL (รูปแบบ PNG)
            const imageDataUrl = canvas.toDataURL('image/png');

            // เปิดรูปภาพในแท็บ/หน้าต่างใหม่
            const newWindow = window.open();
            if (newWindow) {
                newWindow.document.write(`
                    <!DOCTYPE html>
                    <html lang="th">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>ภาพที่ถ่าย</title>
                        <style>
                            body { margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #222; }
                            img { max-width: 100%; max-height: 90vh; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5); }
                        </style>
                    </head>
                    <body>
                        <img src="${imageDataUrl}" alt="Captured Image">
                    </body>
                    </html>
                `);
                newWindow.document.close(); // ปิดสตรีมเอกสาร
            } else {
                showMessageBox('ไม่สามารถเปิดหน้าต่างใหม่ได้: โปรดอนุญาตป๊อปอัปสำหรับเว็บไซต์นี้');
            }
        }

        // เพิ่ม Event Listener สำหรับการแตะ/คลิกที่ใดก็ได้บนโอเวอร์เลย์สีดำ
        blackOverlay.addEventListener('click', captureImage);
        blackOverlay.addEventListener('touchstart', (e) => {
            e.preventDefault(); // ป้องกันพฤติกรรมการสัมผัสเริ่มต้น (เช่น การเลื่อน)
            captureImage();
        });

        // เริ่มต้นการทำงานของกล้องเมื่อหน้าต่างโหลดเสร็จสิ้น
        window.onload = initCamera;

        // หยุดสตรีมกล้องเมื่อหน้าเว็บถูกปิดหรือเปลี่ยนไปหน้าอื่น
        window.onbeforeunload = () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        };
    </script>
</body>
</html>
